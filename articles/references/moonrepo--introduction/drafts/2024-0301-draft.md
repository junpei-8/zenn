---
title: '【moonrepo】モノレポツールの新星 "moon" repo とは？'
emoji: "🌕"
type: "tech"
topics: ["monorepo", "moonrepo", "tool"]
published: false
---

:::details 補足: 各言語のパッケージ管理ファイルについて

各言語のパッケージ管理ファイルは、モノレポ内のプロジェクトをまとめて管理するための言語・ツールチェーン固有の設定ファイルです。

こちらは必須ではないですが、apps から packages を参照したい場合などに必要になるファイルになるので、基本的には用意しておくと良いでしょう。

| 言語   | パッケージ管理ファイル                                                 |
| ------ | ---------------------------------------------------------------------- |
| JS/TS  | `package.json` の `workspaces` フィールドや `pnpm-workspace.yaml` など |
| Rust   | `Cargo.toml` の `workspace` フィールドなど                             |
| Python | `pyproject.toml` の `tool.poetry.packages` など                        |
| Ruby   | 特になし                                                               |

:::

## はじめに

みなさんは「moonrepo（ムーンレポ）」というモノレポ管理ツールをご存じでしょうか？

moonrepo は Rust で作られたタスクランナー兼ビルドツールで、[State of JavaScript 2024](https://2024.stateofjs.com/en-US/libraries/monorepo_tools/#monorepo_tools_ratios) の Monorepo Tools 部門にも名前が挙がっており、じわじわと注目度が高まっているツールです。

最近のモノレポ管理ツールとしては Turborepo や Nx が人気ですが、moonrepo はそれらと比べてよりシンプルな設計思想を持ち、かつ強力な自動化機能を備えているツールといった印象です。

私自身も１年前から個人開発で moonrepo を使っており、Turborepo や Nx で感じていた「使いにくさ」や「痒いところに手が届かない」という課題が解消され、非常に使い勝手の良さを実感しています。

本記事では、そんな moonrepo の魅力を紹介しつつ、どういった人におすすめなのか、目玉機能の紹介、ざっくりした使い方などを伝えられればと思います！

## こんな人におすすめ

moonrepo は、以下のような方に特におすすめです。

1. タスクと依存関係を１つのファイルで定義したい
2. Javascript / Typescript に限定されないモノレポ環境を作りたい
3. 変数や継承を用いてタスクや依存関係の定義をラクしたい
4. 豊富なオプションと高度な自動化を備えつつオプトインで利用したい

### 1. タスクと依存関係を１つのファイルで定義したい

moonrepo はタスクランナー兼ビルドツールであるため、タスクと依存関係を１つのファイルで定義することができます。

以下はシンプルなタスクと依存関係を定義した例です。

```yml:moon.yml
tasks:
  build:
    command: 'echo "Hello build"'

  preview:
    command: 'echo "Hello preview"'
    deps: ["build"]
```

とってもシンプルですね...！✨\
もはや説明不要かとは思うのですが、`command` には実行する任意のコマンドを、`deps` には依存するタスク名を記述しています。

\
では、実際に `preview` タスクを実行してみたとしましょう。

```sh
moon run preview
```

すると、以下の順序で出力されます。

```sh
Hello build   # deps に指定された build タスクが先に実行される
Hello preview # その後 preview タスクが実行される
```

うーん、とても良き。

\
例えば、これと同じことを Turborepo でやろうとすると、以下のようになります。

:::details Turborepo の場合

**`command` に相当する箇所は `package.json` に記述する**

```json:package.json
{
  "scripts": {
    "build": "echo 'Hello build'",
    "preview": "echo 'Hello preview'"
  }
}
```

\
**`deps` に相当する箇所は `turbo.json` に記述する**

```json:turbo.json
{
  "tasks": {
    "preview": {
      "dependsOn": ["build"]
    }
  }
}
```

:::

\
もちろん、感じ方や考え方は人それぞれですので、一概にどちらの書き方が優れているとは言えません。
ただ、moonrepo のように、関連する設定が1つのファイルにまとまっているほうが直感的で管理しやすいと感じる方には、かなり魅力的に映るのではないでしょうか！

### 2. タスク・依存関係の定義を変数的に使い回してラクしたい人

moonrepo は、他のモノレポ管理ツールと同じように、そのタスクがどこを読み込むかを input で明示的に指定することができます。

ただ、そうなったときに、毎回同じファイルをベタ書きするのは大変ですよね？
例えば、テストなど、

そんなときは fileGroups という変数を定義し、それを使い回すことが可能です。

同じコマンドやパス設定を何度も書くのは面倒ですよね。moonrepo では 継承機能 や 変数的な記法 を使って、重複定義をなるべく減らせます。似たような設定を複数のプロジェクト・タスクで使う場合にとても便利です。

fileGroups の他にも、

- env
- vars

なども指定することが可能です。

#### もっとプログラミング的に書きたい！！って方向け

最近 moonrepo は [Pkl configuration](https://moonrepo.dev/docs/guides/pkl-config) をサポートしました。

[Pkl](https://pkl-lang.org/) とは、Apple が開発しているプログラム可能な設定形式で、こちらの設定形式で書くと、.yaml 形式の変数もどきではなく、プログラミング的な完全な変数や if 文、ループまでできてしまいます。
詳しい使い方やこ＝どサンプルなどは公式のドキュメントをご参照ください。

https://moonrepo.dev/docs/guides/pkl-config

### 3. Javascript / Typescript に限定されないモノレポ環境を作りたい

moonrepo は、タスクや依存関係を YAML ファイルで定義するため、基本的にあらゆる言語に対応可能です。
さらに、各言語向けの強力なサポートが以下のように提供されています。

- **Tier 0**： タスクランナーと依存関係の定義をサポート
- **Tier 1**： 言語を設定として指定でき、専用の機能を提供
- **Tier 2**： 言語の構成ファイルなどを解析し、依存関係やタスクを自動推測
- **Tier 3**： 依存関係の自動インストールなど、高度なツールチェーン統合

Tier3 で直接サポートされている言語は、以下の通りです。

- Javascript / Typescript
- Python (Experimental)
- Rust (Experimental)

詳しくは公式ドキュメントをご参照ください。
https://moonrepo.dev/docs#supported-languages

### 2. タスクと依存関係を１つのファイルで定義したい

たとえば Turborepo では、タスク（コマンド）は各 `package.json` に記述し、タスクの依存関係や並列実行設定は `turbo.json` に分散して管理するため、少し分かりにくいなと感じる方もいるのではないでしょうか？

moonrepo ではタスク内容も依存関係も1つの設定ファイルで一元管理できるため、「あれ、どのファイルに記述したっけ…？」と迷うことが少なくなります。

```yml
tasks:
  setup:
    command: "npm install"

  dev:
    command: "vite dev"
```

### 5. 多機能だけど必要最低限の機能だけ選択して使いたい人

えー、この moonrepo さん、ものレポ管理以外にもたくさんの機能を持っています。
一度、大きなカテゴリーでまとめてみましょう。

| 機能                 | 説明                                                             | 類似ツール                   |
| -------------------- | ---------------------------------------------------------------- | ---------------------------- |
| タスクランナー       | タスクと依存関係を一元管理                                       | go-task, justfile, makefile  |
| パッケージ管理 ※1    | 依存パッケージの自動インストールと同期                           | mise, nvm, nodebrew          |
| Git(VCS) Hooks       | コミットやプッシュなどのアクションを検知し、自動でタスク実行する | lefthook, husky, lint-staged |
| コードオーナー管理   | GitHub CODEOWNERSファイルの自動生成・同期                        | -                            |
| 自動依存解決         | タスク実行時の依存関係自動インストール                           | -                            |
| テンプレート生成機能 | テンプレートを生成する機能を提供                                 | Twig, Blade                  |

ここまでの紹介だけでも、かなり様々な機能をカバーしていることがわかると思います。（紹介しきれていない機能もたくさんあります）

ですが、多機能なツールはその分依存することが多く、不要なものを使うのを渋ってしまう気持ちもわかります。

ですが、moonrepo は 基本的にオプトイン のスタイルで、使いたい機能だけ ピンポイントで有効化できるのが特徴です。
何も設定がないと、タスクランナーと依存関係のみを管理するシンプルなツールになります。

そう、moonrepo を使うと。
しかも、moonrepo のモノレポ管理以外の機能は基本的にオプトインとなっているため、たとえば、まだ信頼度が高い husky を使いたい、といった場合も特に設定せず husky を導入することができます。

こちらで特筆すべきはやはり Tier 3 の機能でしょう。

例えば、Tier 3 サポートされている JS/TS だと、以下の設定だけで基本的に開発コマンドは問題なく実行されるようになります。

```yml:moon.yml
tasks:
  dev:
    command: "vite dev" # vite は npm 依存関係である前提
```

```sh
moon run dev
```

この場合、vite は npm の依存関係であるため、通常は最初に `npm install` を実行しないと `vite` が見つからないというエラーで落ちるはずです。

しかし、moonrepo は自動的に package.json があるプロジェクトを JS/TS プロジェクトとして認識し、必要な npm 依存関係を自動でインストールしてくれます。さらに、使用しているパッケージマネージャー（npm、pnpm、bun、deno など）に応じて、適切なインストールコマンドを自動的に選択します。

また、細かい点ですが、一般的なタスクランナーの場合は `command` に `npm run vite dev` と書く必要がありますが、moonrepo は JS/TS プロジェクトと判断した場合、自動的に `npm run` を付与してコマンドを実行してくれます。

なお、この自動判定機能は必要に応じて無効化することもできます。JS/TS 以外のプロジェクトで使用する場合や、より細かい制御が必要な場合は、手動でコマンドを実行するように設定を変更できます。

## moonrepo のその他の魅力

上で挙げた以外にも、moonrepo には「便利だな」と思うポイントがいろいろあります。ここでは大きく 「自動化」と「CI の簡略化」 に分けてご紹介します。

### 1. たくさんの自動化がうれしい

moonrepo は設定ファイルでプロジェクトごとの情報をまとめておくと、さまざまな作業を自動化 してくれます。たとえば:

#### TypeScript の project references 自動入力

複数の TS プロジェクト間で依存関係を設定する際、tsconfig.json の references を手動で書くのは結構大変ですよね。moonrepo はタスクや依存設定を参考に、これを自動で書き換えてくれる機能を持っています。

パスエイリアスやキャッシュディレクトリの設定
複数プロジェクトで共通化できそうな部分は、moonrepo がまとめて管理してくれるので、いちいちコピペしなくても OK。

#### package.json の依存関係の同期

.moon/ や moon.yml に書いた依存関係を、対象のディレクトリの package.json へ自動反映。管理ミスや記載漏れを減らしてくれます。

#### コードオーナーの同期

GitHub の CODEOWNERS を自動生成・更新してくれるので、リポジトリ全体の設定が一貫化しやすいです。

#### タスク実行時に node_modules など依存パッケージを自動インストール

「あ、依存インストールし忘れてビルドコケた…」みたいなミスを減らしてくれます。

### CI がむちゃくちゃ簡略化できる

moonrepo は タスク依存関係の管理 や 差分ビルド の仕組みがしっかりしているので、CI/CD パイプラインの設定がスッキリ します。
具体的には、「このタスクが終わってからあのタスクを実行する」 といったフローが簡単に書けますし、差分検出（変更のあったプロジェクトだけビルド or テスト）を自動でやってくれるため、ビルド時間の短縮や無駄なリソース消費の削減に効果的です。
私の場合、GitHub Actions 上でも「moon コマンド一発」でビルド〜テスト〜デプロイまでを並列・直列にサクッと書けるので、YAML がかなりコンパクトになりました。

## moonrepo のざっくりした使い方

ここからは簡単に、moonrepo の導入～設定の流れをイメージできるよう、ほんの概要だけご紹介します。

プロジェクトに moon.yml を用意
プロジェクトルート直下などに moon.yml を置き、タスクの内容や依存関係を記述します。

```yml
projects:
  my-app:
    tasks:
      build:
        command: npm run build
      test:
        command: npm run test
      # ...etc
```

## 現状の課題と解決策

- **クラウドキャッシュが未実装**
  現時点ではローカルキャッシュのみのため、大規模プロジェクトの効率化には工夫が必要です。
  今後のバージョンアップで対応が予定されているようなので、Changelog をチェックしましょう。

- **ドキュメントが少ない**
  まだ新しいツールなので情報が少ないのが実情です。
  公式ドキュメントや GitHub の Issue、コミュニティなどを積極的に活用すると良いでしょう。

## まとめ

日本語の情報が少ないぶん、最初は戸惑う点もあるかもしれませんが、オプトインで徐々に導入できる のが moonrepo の良いところ。
「とりあえずタスクランナーとして試してみる」→「CI を連携してみる」→「ツールチェーン管理やコードオーナー同期を活用」……とステップを踏めば、きっと快適なモノレポライフが待っています！

もしこの記事を読んで「ちょっと面白そうかも」と思ったら、ぜひ一度 moonrepo を試してみてください。
「mono」の typo じゃありません。「moon」 です！ それだけは覚えて帰ってもらえたら嬉しいです（笑）

それでは、快適なモノレポライフを楽しんでくださいね。ありがとうございました！
